syntax = "proto3";

package bonanza.model.evaluation.expecteddependencies;

import "bonanza.build/pkg/proto/model/core/core.proto";
import "google/protobuf/timestamp.proto";

option go_package = "bonanza.build/pkg/proto/model/evaluation/expecteddependencies";

// Expected Dependencies is data that is generated by the evaluation
// framework and written to the Object Store and referenced by the Tag
// Store, allowing subsequent evaluations to perform well targeted cache
// lookups for previously computed results.
//
// For each key to be evaluated, the evaluation framework can look up
// the tag using a key based on the TagKeyHashInput message. This yields
// an object containing an ExpectedDependencies message, which contains
// candidate sets of dependencies for which cache lookups can be
// performed.

message Dependencies {
  message Leaf {
    // The key of a dependency.
    bonanza.model.core.Any key = 1;

    // If set, it has been observed that this key is not always a
    // dependency of the requested key. This means that whether or not
    // it is a dependency is conditional on the value of a previously
    // requested dependency. It is therefore not a good idea to let the
    // evaluation of the requested key be blocked on this specific
    // dependency.
    //
    // This field holds a timestamp of the first moment in time it was
    // observed that this dependency was conditional. If a sufficient
    // amount of time has passed, it may be desirable to stop marking it
    // as conditional, and keeping or discarding it. This prevents the
    // dependency from being marked conditional indefinitely.
    google.protobuf.Timestamp marked_conditional_timestamp = 2;
  }

  message Parent {
    bonanza.model.core.DecodableReference reference = 1
        [(bonanza.model.core.object_format) = {
          proto_list_type_name:
            "bonanza.model.evaluation.expecteddependencies.Dependencies";
        }];
  }

  oneof level {
    // A single dependency.
    Leaf leaf = 1;

    // B-tree node containing additional dependencies.
    Parent parent = 2;
  }
}

message TagKeyHashInput {
  // SHA-256 hash of the bonanza.model.tag.CommonKeyHashInput message
  // containing common parameters that need to be considered when
  // computing a tag key hash.
  bytes common_tag_key_hash = 1;

  // SHA-256 hash of the list of all keys for which overrides were
  // specified in the Action message.
  bytes keys_with_overrides_hash = 2;

  // SHA-256 hash of the evaluation key for which the expected
  // dependencies are being looked up.
  bytes key_hash = 3;
}

message ExpectedDependencies {
  // The set of expected direct dependencies of this evaluation key.
  repeated Dependencies direct_dependencies = 1;

  // The set of expected dependencies, either direct or transitive,
  // having a lower SHA-256 hash than the provided evaluation key, or
  // for which an override is in place.
  //
  // This set does not include dependencies that are fully shadowed by
  // other dependencies in this set.
  //
  // Because these sets may be constructed by merging other sets, there
  // may be a large amount of redundancy in this set. It is recommended
  // to aggressively deduplicate when iterating.
  repeated Dependencies dependencies_with_lower_hash = 2;
}
